steps:
- task: PowerShell@2
  displayName: 'Install Latest PowerShell'

  inputs:
    targetType: 'inline'
    script: |
      if ($PSVersionTable.PSVersion.Major -lt 7) {
          try {
              $File = "$(System.DefaultWorkingDirectory)/Install-PowerShell.ps1"
              Invoke-WebRequest -Uri "https://aka.ms/install-powershell.ps1") -OutFile $File

              Set-ExecutionPolicy Unrestricted -Scope CurrentUser -Force
              & $File -ErrorAction Stop
          }
          catch {
              $_ | Out-String | Write-Host
              throw $_.Message
          }
      }

    errorActionPreference: 'stop'
    failOnStderr: true
    pwsh: true
